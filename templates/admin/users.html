{% from "shared/modals.html" import confirm_modal, upload_modal %}
{% extends "admin/base_admin.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏{% endblock %}

{% block admin_content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="text-info-emphasis"><i class="fa fa-users"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
        <div class="btn-group" role="group">
            <a href="{{ url_for('admin.create_user') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            </a>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importUsersModal">
                <i class="fas fa-upload"></i> –ò–º–ø–æ—Ä—Ç
            </button>
            <a href="{{ url_for('admin.export_users') }}" class="btn btn-info">
                <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö
            </a>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
          <div class="card bg-light text-center shadow-sm">
            <div class="card-body p-2">
              <div class="fw-bold">{{ users|length }}</div>
              <small class="text-muted">–í—Å–µ–≥–æ</small>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card text-center shadow-sm">
            <div class="card-body p-2">
              <div class="fw-bold">
                {{ users|selectattr("role", "equalto", "student")|list|length }}
              </div>
              <small class="text-muted">–°—Ç—É–¥–µ–Ω—Ç–æ–≤</small>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card text-center shadow-sm">
            <div class="card-body p-2">
              <div class="fw-bold">
                {{ users|selectattr("role", "equalto", "teacher")|list|length }}
              </div>
              <small class="text-muted">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</small>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card text-center shadow-sm">
            <div class="card-body p-2">
              <div class="fw-bold">
                {{ users|selectattr("role", "equalto", "admin")|list|length }}
              </div>
              <small class="text-muted">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</small>
            </div>
          </div>
        </div>
      </div>
      
    <div class="btn-group mb-4">
        <a href="{{ url_for('auth.register') }}" class="btn btn-primary"><i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>
    </div>

    <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>Email</th>
                    <th>–†–æ–ª—å</th>
                    <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td><input type="checkbox" class="user-checkbox" value="{{ user.id }}"></td>
                    <td>
                        {% if user.role == 'admin' %}<i class="fas fa-cog"></i>
                        {% elif user.role == 'teacher' %}<i class="fas fa-chalkboard-teacher"></i>
                        {% elif user.role == 'student' %}<i class="fas fa-user-graduate"></i>
                        {% else %}<i class="fas fa-user"></i>
                        {% endif %}
                        {{ user.username }}
                        {% if user.get_full_name() != user.username %}
                            <br><small class="text-info">{{ user.get_full_name() }}</small>
                        {% endif %}
                    </td>
                    <td>{{ user.email }}</td>
                    <td>
                        <span class="role-badge role-{{ user.role }}">{{ user.role }}</span>
                    </td>
                    <td>
                        {% if user.created_at %}
                            {{ user.created_at.strftime('%d.%m.%Y') }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" class="btn btn-outline-primary" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><i class="fas fa-edit"></i></a>
                            {% if user.role != 'admin' %}
                                <a href="#" 
                                    class="btn btn-outline-danger" 
                                    title="–£–¥–∞–ª–∏—Ç—å"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteUserModal"
                                    data-user-id="{{ user.id }}"
                                    data-username="{{ user.username }}">
                                    <i class="fas fa-trash"></i>
                                </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="mt-3">
            <button type="button" class="btn btn-info" onclick="exportSelected()" id="exportSelectedBtn" disabled>
                <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
            </button>
            <span class="text-muted ml-2">–í—Å–µ–≥–æ: <span id="selectedCount">0</span></span>   
        </div>

    {% if not users %}
    <div class="empty-state">
        <div class="empty-icon">üë•</div>
        <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
        <p>–í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</p>
        <a href="{{ url_for('auth.register') }}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>
    </div>
    {% endif %}

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–º–ø–æ—Ä—Ç–∞ (Bootstrap) -->
    <!-- TODO: –£–¥–∞–ª–∏—Ç—å
    <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="importModalLabel">–ò–º–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
        <div class="modal-body">
          <form id="importForm" enctype="multipart/form-data">
            {{ csrf_field() }}
            <div class="mb-3">
              <label for="importFile" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ JSON —Ñ–∞–π–ª —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏:</label>
              <input type="file" class="form-control" id="importFile" name="file" accept=".json" required>
            </div>
            <div class="alert alert-info">
              <h6>–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:</h6>
              <pre><code>[
    {
        "username": "student1", -- –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ
        "email": "student1@example.com", -- email, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ
        "password": "password123", -- –ø–∞—Ä–æ–ª—å, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
        "role": "student", -- —Ä–æ–ª—å, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è admin, teacher, student
    }
  ]</code></pre>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-success" onclick="importUsers()">
            <i class="fas fa-upload"></i> –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
          </button>
        </div>
      </div>
    </div>
  </div>
-->
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <!-- TODO: –£–¥–∞–ª–∏—Ç—å 
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-danger">
              <h5 class="modal-title text-light" id="deleteConfirmLabel">–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
              <p class="mb-0">
                –í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <strong id="deleteUserName"></strong>?
              </p>
              <p class="text-danger small mt-2 mb-0">
                –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ <strong>–Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å</strong>.
              </p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
              <form id="deleteUserForm" method="POST">
                {{ csrf_field() }}
                <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    -->

    {# URL-—à–∞–±–ª–æ–Ω —Å –Ω—É–ª—ë–º –¥–ª—è JS-–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ #}
    {% set delete_user_url_template = url_for('admin.delete_user', user_id=0) %}
    {% set users_format_note %}
        <div class="alert alert-info small mb-3">
        <strong>–§–æ—Ä–º–∞—Ç:</strong>
        <pre class="mb-0">[
        {
            "username": "student1",    -- –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
            "email": "student1@example.com", -- email, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
            "password": "password123", -- –ø–∞—Ä–æ–ª—å, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
            "role": "student",         -- admin | teacher | student
            "first_name": "–ò–≤–∞–Ω",
            "last_name": "–ò–≤–∞–Ω–æ–≤"
        }
        ]</pre>
        </div>
    {% endset %}

    {% call confirm_modal(
        id='deleteUserModal',
        title='–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
        body='–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <strong id="deleteUserName"></strong>?',
        action=delete_user_url_template,
        confirm_text='–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞',
        confirm_class='btn-danger',
        alert_note='–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.'
    ) %}
    {{ csrf_field() }}
    {% endcall %}

    {{ upload_modal(
        id='importUsersModal',
        title='–ò–º–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
        action=url_for('admin.import_users'),
        input_name='file',
        accept='.json',
        submit_text='–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å',
        method='post',
        csrf_html=csrf_field(),
        header_note=users_format_note   
    ) }}


    <script>
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞–º–∏
        document.getElementById('selectAll').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateExportButton();
        });
        
        document.querySelectorAll('.user-checkbox').forEach(cb => {
            cb.addEventListener('change', updateExportButton);
        });
        
        function updateExportButton() {
            const selected = document.querySelectorAll('.user-checkbox:checked');
            const exportBtn = document.getElementById('exportSelectedBtn');
            exportBtn.disabled = selected.length === 0;
            document.getElementById('selectedCount').textContent = selected.length;
        }
        

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏—è -->
        document.addEventListener('DOMContentLoaded', () => {
            const modalEl = document.getElementById('deleteUserModal');
            if (!modalEl) return;

            modalEl.addEventListener('show.bs.modal', (event) => {
                const btn = event.relatedTarget;
            const userId = btn.getAttribute('data-user-id');
            const username = btn.getAttribute('data-username');

            // –∑–∞–º–µ–Ω–∏—Ç—å .../delete/0 –Ω–∞ .../delete/<id>
            const form = modalEl.querySelector('form');
            form.action = form.action.replace(/0$/, userId);

            // —Ç–µ–∫—Å—Ç –º–æ–¥–∞–ª–∫–∏
            const body = modalEl.querySelector('.modal-body');
            body.innerHTML = `<p class="mb-0">–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <strong>${username}</strong>?</p>
            <p class="text-danger small mt-2 mb-0">
                –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.
            </p>`;
            });
        });


        // –ò–º–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function importUsers() {
            const form = document.getElementById('importForm');
            const formData = new FormData(form);

            // –æ—Ç–ª–∞–¥–∫–∞: —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ —É—Ö–æ–¥–∏—Ç
            for (const [k, v] of formData.entries()) {
                console.log('FD:', k, v, v && v.name);
            }
            console.log('direct file:', document.getElementById('importFile').files[0]);

            fetch('{{ url_for("admin.import_users") }}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('importModal'))?.hide();
                    alert('–£—Å–ø–µ—à–Ω–æ!\n' + data.message);
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞!\n' + data.message);
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ: ' + error);
            });
            
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function exportSelected() {
            const selected = Array.from(document.querySelectorAll('.user-checkbox:checked'))
                                  .map(cb => parseInt(cb.value));
            
            if (selected.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            
            fetch('{{ url_for("admin.export_users") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                },
                body: JSON.stringify({selected_ids: selected})
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ');
                    });
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `selected_users_export_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + error.message);
            });
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.addEventListener('DOMContentLoaded', function () {
            const deleteModal = document.getElementById('deleteConfirmModal');
            const deleteUserName = document.getElementById('deleteUserName');
            const deleteForm = document.getElementById('deleteUserForm');

            // –®–∞–±–ª–æ–Ω URL, –Ω–æ –±–µ–∑ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ ID ‚Äî –≤ Flask –ø–µ—Ä–µ–¥–∞—ë–º 0
            const deleteUrlTemplate = "{{ url_for('admin.delete_user', user_id=0) }}";

            deleteModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const userId = button.getAttribute('data-user-id');
                const username = button.getAttribute('data-username');

                deleteUserName.textContent = username;

                // –ú–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç URL, –∑–∞–º–µ–Ω—è—è "0" –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID
                deleteForm.action = deleteUrlTemplate.replace(/0$/, userId);
            });
        });
        </script>
{% endblock %}
