{% extends "admin/base_admin.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% endblock %}

{% block content %}
<div class="admin-content">
    <h2>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    
    <div class="analytics-dashboard">
        <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-overview">
            <h3>üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-number">{{ total_users or 0 }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    <div class="stat-change positive">+12% –∑–∞ –º–µ—Å—è—Ü</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üìù</div>
                    <div class="stat-number">{{ total_tasks or 0 }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π</div>
                    <div class="stat-change positive">+8% –∑–∞ –º–µ—Å—è—Ü</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-number">{{ total_attempts or 0 }}</div>
                    <div class="stat-label">–ü–æ–ø—ã—Ç–æ–∫ —Ä–µ—à–µ–Ω–∏—è</div>
                    <div class="stat-change positive">+25% –∑–∞ –º–µ—Å—è—Ü</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-number">{{ success_rate or 0 }}%</div>
                    <div class="stat-label">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</div>
                    <div class="stat-change positive">+3% –∑–∞ –º–µ—Å—è—Ü</div>
                </div>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
        <div class="charts-section">
            <div class="chart-container">
                <h3>üìÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                <div class="chart-placeholder">
                    <canvas id="userActivityChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>üéØ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—à–µ–Ω–∏–π</h3>
                <div class="chart-placeholder">
                    <canvas id="solutionStatsChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- –¢–æ–ø –∑–∞–¥–∞–Ω–∏–π -->
        <div class="top-tasks-section">
            <h3>üèÜ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h3>
            <div class="tasks-table">
                <table class="analytics-table">
                    <thead>
                        <tr>
                            <th>–ó–∞–¥–∞–Ω–∏–µ</th>
                            <th>–ü–æ–ø—ã—Ç–æ–∫</th>
                            <th>–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</th>
                            <th>–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
                            <th>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if popular_tasks %}
                            {% for task in popular_tasks %}
                            <tr>
                                <td>
                                    <div class="task-info">
                                        <strong>{{ task.title }}</strong>
                                        <small>{{ task.topic }}</small>
                                    </div>
                                </td>
                                <td>{{ task.attempts_count or 0 }}</td>
                                <td>
                                    <span class="success-rate {{ 'high' if (task.success_rate or 0) > 70 else 'medium' if (task.success_rate or 0) > 40 else 'low' }}">
                                        {{ task.success_rate or 0 }}%
                                    </span>
                                </td>
                                <td>
                                    <div class="difficulty-bar">
                                        <div class="difficulty-fill" data-difficulty="{{ task.difficulty_level or 1 }}"></div>
                                        <span>{{ task.difficulty_level or 1 }}/5</span>
                                    </div>
                                </td>
                                <td>{{ task.avg_time or 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="no-data">–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
        <div class="active-users-section">
            <h3>üåü –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
            <div class="users-grid">
                {% if active_users %}
                    {% for user in active_users %}
                    <div class="user-card">
                        <div class="user-avatar">
                            {% if user.role == 'student' %}üéì
                            {% elif user.role == 'teacher' %}üë®‚Äçüè´
                            {% else %}üîß
                            {% endif %}
                        </div>
                        <div class="user-info">
                            <strong>{{ user.username }}</strong>
                            <small>{{ user.role }}</small>
                        </div>
                        <div class="user-stats">
                            <div class="stat-item">
                                <span class="stat-value">{{ user.tasks_completed or 0 }}</span>
                                <span class="stat-label">–∑–∞–¥–∞–Ω–∏–π</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">{{ user.success_rate or 0 }}%</span>
                                <span class="stat-label">—É—Å–ø–µ—à–Ω–æ—Å—Ç—å</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-data">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                {% endif %}
            </div>
        </div>

        <!-- –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö -->
        <div class="export-section">
            <h3>üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
            <div class="export-buttons">
                <button class="btn btn-primary" onclick="exportData('users')">
                    üë• –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                </button>
                <button class="btn btn-primary" onclick="exportData('tasks')">
                    üìù –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–¥–∞–Ω–∏–π
                </button>
                <button class="btn btn-primary" onclick="exportData('attempts')">
                    ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ø—ã—Ç–æ–∫
                </button>
                <button class="btn btn-success" onclick="exportData('full')">
                    üìä –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.analytics-dashboard {
    display: flex;
    flex-direction: column;
    gap: 30px;
}

.stats-overview {
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.stat-card:nth-child(2) {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.stat-card:nth-child(3) {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.stat-card:nth-child(4) {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.stat-icon {
    font-size: 2em;
    margin-bottom: 10px;
    opacity: 0.8;
}

.stat-number {
    font-size: 2.5em;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9em;
    opacity: 0.9;
    margin-bottom: 10px;
}

.stat-change {
    font-size: 0.8em;
    padding: 3px 8px;
    border-radius: 12px;
    background: rgba(255,255,255,0.2);
}

.stat-change.positive {
    color: #4ade80;
}

.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
}

.chart-container {
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.chart-placeholder {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    color: #666;
    margin-top: 15px;
}

.top-tasks-section,
.active-users-section,
.export-section {
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.analytics-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.analytics-table th,
.analytics-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.analytics-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #333;
}

.task-info strong {
    display: block;
    color: #333;
}

.task-info small {
    color: #666;
    font-size: 0.8em;
}

.success-rate {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 500;
}

.success-rate.high {
    background: #dcfce7;
    color: #166534;
}

.success-rate.medium {
    background: #fef3c7;
    color: #92400e;
}

.success-rate.low {
    background: #fee2e2;
    color: #991b1b;
}

.difficulty-bar {
    position: relative;
    background: #e5e7eb;
    border-radius: 10px;
    height: 20px;
    width: 100px;
    overflow: hidden;
}

.difficulty-fill {
    background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
    height: 100%;
    transition: width 0.3s ease;
}

.difficulty-bar span {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.7em;
    font-weight: 500;
    color: #374151;
}

.users-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.user-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.user-avatar {
    font-size: 2em;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border-radius: 50%;
}

.user-info strong {
    display: block;
    color: #333;
}

.user-info small {
    color: #666;
    text-transform: capitalize;
}

.user-stats {
    margin-left: auto;
    text-align: right;
}

.stat-item {
    margin-bottom: 5px;
}

.stat-value {
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    font-size: 0.8em;
    color: #666;
    margin-left: 5px;
}

.export-buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.no-data {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 40px;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    
    .charts-section {
        grid-template-columns: 1fr;
    }
    
    .export-buttons {
        flex-direction: column;
    }
}
</style>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ (–∑–∞–≥–ª—É—à–∫–∞)
document.addEventListener('DOMContentLoaded', function() {
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Chart.js –∏–ª–∏ –¥—Ä—É–≥–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    console.log('Analytics page loaded');
    
    // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    const chartPlaceholders = document.querySelectorAll('.chart-placeholder canvas');
    chartPlaceholders.forEach(canvas => {
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#6b7280';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('–ì—Ä–∞—Ñ–∏–∫ –±—É–¥–µ—Ç –∑–¥–µ—Å—å', canvas.width/2, canvas.height/2);
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ difficulty bars
    const difficultyFills = document.querySelectorAll('.difficulty-fill[data-difficulty]');
    difficultyFills.forEach(fill => {
        const difficulty = parseFloat(fill.getAttribute('data-difficulty'));
        const width = difficulty * 20; // 20% –∑–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        fill.style.width = width + '%';
    });
});

function exportData(type) {
    // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
    const exportTypes = {
        'users': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
        'tasks': '–ó–∞–¥–∞–Ω–∏—è', 
        'attempts': '–ü–æ–ø—ã—Ç–∫–∏ —Ä–µ—à–µ–Ω–∏—è',
        'full': '–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç'
    };
    
    alert(`–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö: ${exportTypes[type]}\n(–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)`);
    
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
    console.log(`Exporting ${type} data...`);
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
function updateStats() {
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    console.log('Updating statistics...');
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(updateStats, 30000);
</script>
{% endblock %}
