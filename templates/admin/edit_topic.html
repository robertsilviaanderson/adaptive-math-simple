{% extends "admin/base_admin.html" %}
{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–º—ã{% endblock %}
{% block admin_content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üìö –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–º—ã: {{ topic.name }}</h2>
        <a href="{{ url_for('admin.topics') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Ç–µ–º–∞–º
        </a>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–º–µ -->
    <div class="section mb-4">
        <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            {{ form_start(action=url_for('admin.edit_topic', topic_id=topic.id), method='POST', class='topic-form') }}
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="code">–ö–æ–¥ —Ç–µ–º—ã <span class="text-danger">*</span></label>
                        <input type="text" id="code" name="code" class="form-control" 
                               value="{{ topic.code }}" 
                               pattern="[a-z0-9_]+" 
                               title="–¢–æ–ª—å–∫–æ —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è"
                               required>
                        <small class="form-text text-muted">
                            –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–µ–º—ã
                        </small>
                    </div>
                    
                    <div class="form-group col-md-6">
                        <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã <span class="text-danger">*</span></label>
                        <input type="text" id="name" name="name" class="form-control" 
                               value="{{ topic.name }}" 
                               required>
                        <small class="form-text text-muted">
                            –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã
                        </small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã</label>
                    <textarea id="description" name="description" class="form-control w-100" rows="5"
                              placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã –∏ –µ—ë —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è..."></textarea>
                    <small class="form-text text-muted d-block">
                        –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
                    </small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                    <a href="{{ url_for('admin.topics') }}" class="btn btn-secondary ml-2">
                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for level in ['low', 'medium', 'high'] %}
                {% set config = configs.get(level) %}
                <div class="col-md-4">
                    <div class="level-config level-{{ level }}">
                        <h6>
                            {% if level == 'low' %}üü¢ –ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å
                            {% elif level == 'medium' %}üü° –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å
                            {% else %}üî¥ –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å
                            {% endif %}
                        </h6>
                        
                        {% if config %}
                        <form class="level-config-form" data-level="{{ level }}" data-config-id="{{ config.id }}">
                            {{ csrf_field() }}
                            <div class="form-group">
                                <label>–ü–æ—Ä–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á:</label>
                                <input type="number" name="task_count_threshold" 
                                       class="form-control form-control-sm" 
                                       value="{{ config.task_count_threshold }}" 
                                       min="1" max="50" required>
                            </div>
                            
                            <div class="form-group">
                                <label>–≠—Ç–∞–ª–æ–Ω–Ω–æ–µ –≤—Ä–µ–º—è (—Å–µ–∫):</label>
                                <input type="number" name="reference_time" 
                                       class="form-control form-control-sm" 
                                       value="{{ config.reference_time }}" 
                                       min="30" max="3600" required>
                                <small class="form-text text-muted">
                                    {{ (config.reference_time / 60)|round(1) }} –º–∏–Ω
                                </small>
                            </div>
                            
                            <div class="form-group">
                                <label>–®—Ç—Ä–∞—Ñ—ã –∑–∞ –ø–æ–ø—ã—Ç–∫–∏:</label>
                                <div class="input-group input-group-sm">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">2-—è:</span>
                                    </div>
                                    <input type="number" name="penalty_2" 
                                           class="form-control" 
                                           value="{{ config.penalty_weights[0] if config.penalty_weights|length > 0 else 0.7 }}" 
                                           min="0" max="1" step="0.1" required>
                                </div>
                                <div class="input-group input-group-sm mt-1">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">3-—è:</span>
                                    </div>
                                    <input type="number" name="penalty_3" 
                                           class="form-control" 
                                           value="{{ config.penalty_weights[1] if config.penalty_weights|length > 1 else 0.4 }}" 
                                           min="0" max="1" step="0.1" required>
                                </div>
                                <small class="form-text text-muted">
                                    1-—è –ø–æ–ø—ã—Ç–∫–∞ –≤—Å–µ–≥–¥–∞ = 1.0
                                </small>
                            </div>
                            
                            <button type="button" class="btn btn-sm btn-success" onclick="saveConfig('{{ level }}')">
                                <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                        </form>
                        {% else %}
                        <div class="alert alert-warning">
                            <small>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="alert alert-info mt-3">
                <h6><i class="fas fa-info-circle"></i> –û –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ö —É—Ä–æ–≤–Ω–µ–π</h6>
                <ul class="mb-0">
                    <li><strong>–ü–æ—Ä–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á</strong> - –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞</li>
                    <li><strong>–≠—Ç–∞–ª–æ–Ω–Ω–æ–µ –≤—Ä–µ–º—è</strong> - –æ–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è —Ä–µ—à–µ–Ω–∏—è –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏ –Ω–∞ –¥–∞–Ω–Ω–æ–º —É—Ä–æ–≤–Ω–µ</li>
                    <li><strong>–®—Ç—Ä–∞—Ñ—ã –∑–∞ –ø–æ–ø—ã—Ç–∫–∏</strong> - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —Å–Ω–∏–∂–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ –∑–∞ 2-—é –∏ 3-—é –ø–æ–ø—ã—Ç–∫–∏</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–µ -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–µ</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="stat-card">
                        <h6>–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π</h6>
                        <div class="stat-number">{{ topic.tasks.count() }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <h6>–ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å</h6>
                        <div class="stat-number text-success">{{ topic.tasks.filter_by(level='low').count() }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <h6>–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å</h6>
                        <div class="stat-number text-warning">{{ topic.tasks.filter_by(level='medium').count() }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <h6>–í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å</h6>
                        <div class="stat-number text-danger">{{ topic.tasks.filter_by(level='high').count() }}</div>
                    </div>
                </div>
            </div>
            
            {% if topic.tasks.count() > 0 %}
            <div class="mt-3">
                <a href="{{ url_for('admin.tasks') }}?topic={{ topic.id }}" class="btn btn-outline-primary">
                    <i class="fas fa-tasks"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–¥–∞–Ω–∏—è –ø–æ —Ç–µ–º–µ
                </a>
            </div>
            {% endif %}
        </div>
    </div>

<script>
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω—è
function saveConfig(level) {
    const form = document.querySelector(`form[data-level="${level}"]`);
    const formData = new FormData(form);
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    const data = {
        task_count_threshold: parseInt(formData.get('task_count_threshold')),
        reference_time: parseInt(formData.get('reference_time')),
        penalty_weights: [
            parseFloat(formData.get('penalty_2')),
            parseFloat(formData.get('penalty_3'))
        ]
    };
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å (–∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π)
    fetch(`/admin/topics/{{ topic.id }}/config/${level}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            const btn = form.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-success');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-outline-success');
                btn.classList.add('btn-success');
            }, 2000);
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + data.message);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ' + error);
    });
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
document.querySelector('.topic-form').addEventListener('submit', function(e) {
    const code = document.getElementById('code').value;
    const name = document.getElementById('name').value;
    
    if (!code.match(/^[a-z0-9_]+$/)) {
        e.preventDefault();
        alert('–ö–æ–¥ —Ç–µ–º—ã –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ—á–Ω—ã–µ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è');
        return;
    }
    
    if (code.length < 3) {
        e.preventDefault();
        alert('–ö–æ–¥ —Ç–µ–º—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
        return;
    }
    
    if (name.length < 3) {
        e.preventDefault();
        alert('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
        return;
    }
});

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö
document.querySelectorAll('input[name="reference_time"]').forEach(input => {
    input.addEventListener('input', function() {
        const minutes = (this.value / 60).toFixed(1);
        const small = this.parentNode.querySelector('.form-text');
        small.textContent = `${minutes} –º–∏–Ω`;
    });
});
</script>

<style>
.level-config {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border-left: 4px solid #6c757d;
}

.level-config.level-low {
    border-left-color: #28a745;
}

.level-config.level-medium {
    border-left-color: #ffc107;
}

.level-config.level-high {
    border-left-color: #dc3545;
}

.level-config h6 {
    margin-bottom: 15px;
    color: #495057;
}

.stat-card {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    border: 1px solid #dee2e6;
}

.stat-card h6 {
    margin-bottom: 10px;
    color: #6c757d;
    font-size: 0.9rem;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #495057;
}

.form-actions {
    border-top: 1px solid #dee2e6;
    padding-top: 20px;
    margin-top: 20px;
}

.input-group-text {
    min-width: 40px;
    justify-content: center;
}

.topic-form .form-group {
  display: block;           /* —Å–±–∏–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–π flex —É .form-group */
  width: 100%;
}

.topic-form textarea.form-control {
  width: 100%;              /* —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –ø–æ–ª–µ */
}

.topic-form .form-text {
  display: block;           /* –ø–µ—Ä–µ–Ω–æ—Å–∏–º –ø–æ–¥–ø–∏—Å—å –ø–æ–¥ –ø–æ–ª–µ */
  margin-top: .25rem;
}
</style>
{% endblock %}
