{% extends "admin/base_admin.html" %}
{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–º—ã{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>üìö –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–º—ã: {{ topic.name }}</h2>
  <a href="{{ url_for('admin.topics') }}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Ç–µ–º–∞–º
  </a>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
<div class="card mb-4">
  <div class="card-body">
    <h3 class="mb-3">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>

    <form action="{{ url_for('admin.edit_topic', topic_id=topic.id) }}" method="post" class="topic-form">
      <!-- CSRF –∫–∞–∫ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ -->
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="row g-3">
        <div class="col-md-6">
          <label for="code" class="form-label">–ö–æ–¥ —Ç–µ–º—ã <span class="text-danger">*</span></label>
          <input
            type="text"
            id="code"
            name="code"
            class="form-control"
            value="{{ topic.code }}"
            pattern="[a-z0-9_]+"
            title="–¢–æ–ª—å–∫–æ —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è"
            required
          >
          <div class="form-text">
            –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–µ–º—ã (—Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _)
          </div>
        </div>

        <div class="col-md-6">
          <label for="name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã <span class="text-danger">*</span></label>
          <input
            type="text"
            id="name"
            name="name"
            class="form-control"
            value="{{ topic.name }}"
            required
          >
          <div class="form-text">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã</div>
        </div>
      </div>

      <div class="mt-3">
        <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã</label>
        <textarea
          id="description"
          name="description"
          class="form-control"
          rows="5"
          placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã –∏ –µ—ë —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è..."
        >{{ topic.description }}</textarea>
        <div class="form-text">–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</div>
      </div>

      <div class="form-actions mt-4 pt-3 border-top">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        </button>
        <a href="{{ url_for('admin.topics') }}" class="btn btn-outline-secondary ms-2">
          <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
        </a>
      </div>
    </form>
  </div>
</div>

<!-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ -->
<div class="card">
  <div class="card-body">
    <h3 class="mb-3">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</h3>

    <div class="row g-3">
      {% for level in ['low', 'medium', 'high'] %}
      {% set config = configs.get(level) %}
      <div class="col-md-4">
        <div class="level-config level-{{ level }}">
          <h6 class="mb-3">
            {% if level == 'low' %}üü¢ –ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å
            {% elif level == 'medium' %}üü° –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å
            {% else %}üî¥ –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å
            {% endif %}
          </h6>

          {% if config %}
          <form class="level-config-form" data-level="{{ level }}" data-config-id="{{ config.id }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="mb-2">
              <label class="form-label">–ü–æ—Ä–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á</label>
              <input type="number" name="task_count_threshold"
                     class="form-control form-control-sm"
                     value="{{ config.task_count_threshold }}"
                     min="1" max="50" required>
            </div>

            <div class="mb-2">
              <label class="form-label">–≠—Ç–∞–ª–æ–Ω–Ω–æ–µ –≤—Ä–µ–º—è (—Å–µ–∫)</label>
              <input type="number" name="reference_time"
                     class="form-control form-control-sm"
                     value="{{ config.reference_time }}"
                     min="30" max="3600" required>
              <div class="form-text">{{ (config.reference_time / 60)|round(1) }} –º–∏–Ω</div>
            </div>

            <div class="mb-3">
              <label class="form-label">–®—Ç—Ä–∞—Ñ—ã –∑–∞ –ø–æ–ø—ã—Ç–∫–∏</label>

              <!-- BS5: –±–µ–∑ input-group-prepend, –∏—Å–ø–æ–ª—å–∑—É–µ–º span –≤–Ω—É—Ç—Ä–∏ .input-group-text -->
              <div class="input-group input-group-sm mb-1">
                <span class="input-group-text">2-—è</span>
                <input type="number" name="penalty_2" class="form-control"
                       value="{{ config.penalty_weights[0] if config.penalty_weights|length > 0 else 0.7 }}"
                       min="0" max="1" step="0.1" required>
              </div>

              <div class="input-group input-group-sm">
                <span class="input-group-text">3-—è</span>
                <input type="number" name="penalty_3" class="form-control"
                       value="{{ config.penalty_weights[1] if config.penalty_weights|length > 1 else 0.4 }}"
                       min="0" max="1" step="0.1" required>
              </div>

              <div class="form-text">1-—è –ø–æ–ø—ã—Ç–∫–∞ –≤—Å–µ–≥–¥–∞ = 1.0</div>
            </div>

            <button type="button" class="btn btn-sm btn-success" onclick="saveConfig('{{ level }}')">
              <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
          </form>
          {% else %}
          <div class="alert alert-warning mb-0">
            <small>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</small>
          </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="alert alert-info mt-3 mb-0">
      <h6 class="mb-2"><i class="fas fa-info-circle"></i> –û –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ö —É—Ä–æ–≤–Ω–µ–π</h6>
      <ul class="mb-0">
        <li><strong>–ü–æ—Ä–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á</strong> ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –∑–∞–¥–∞—á –¥–ª—è –æ—Ü–µ–Ω–∫–∏.</li>
        <li><strong>–≠—Ç–∞–ª–æ–Ω–Ω–æ–µ –≤—Ä–µ–º—è</strong> ‚Äî –æ–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è —Ä–µ—à–µ–Ω–∏—è –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ.</li>
        <li><strong>–®—Ç—Ä–∞—Ñ—ã</strong> ‚Äî –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –¥–ª—è 2-–π –∏ 3-–π –ø–æ–ø—ã—Ç–æ–∫.</li>
      </ul>
    </div>
  </div>
</div>

<script>
// –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã
document.querySelector('.topic-form').addEventListener('submit', function(e) {
  const code = document.getElementById('code').value.trim();
  const name = document.getElementById('name').value.trim();

  if (!/^[a-z0-9_]+$/.test(code)) {
    e.preventDefault();
    alert('–ö–æ–¥ —Ç–µ–º—ã –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ—á–Ω—ã–µ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è');
    return;
  }
  if (code.length < 3) {
    e.preventDefault();
    alert('–ö–æ–¥ —Ç–µ–º—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
    return;
  }
  if (name.length < 3) {
    e.preventDefault();
    alert('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
    return;
  }
});

// –ü–µ—Ä–µ—Å—á—ë—Ç –º–∏–Ω—É—Ç
document.querySelectorAll('input[name="reference_time"]').forEach(input => {
  input.addEventListener('input', function () {
    const minutes = (this.value / 60).toFixed(1);
    const hint = this.closest('.mb-2').querySelector('.form-text');
    if (hint) hint.textContent = `${minutes} –º–∏–Ω`;
  });
});

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω—è (AJAX)
function saveConfig(level) {
  const form = document.querySelector(`form[data-level="${level}"]`);
  const formData = new FormData(form);

  const payload = {
    task_count_threshold: parseInt(formData.get('task_count_threshold')),
    reference_time: parseInt(formData.get('reference_time')),
    penalty_weights: [
      parseFloat(formData.get('penalty_2')),
      parseFloat(formData.get('penalty_3'))
    ]
  };

  fetch(`/admin/topics/{{ topic.id }}/config/${level}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
    },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      const btn = form.querySelector('button[type="button"]');
      const original = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-check"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-success');
      setTimeout(() => {
        btn.innerHTML = original;
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-success');
      }, 2000);
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + (data.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
    }
  })
  .catch(err => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err));
}
</script>

<style>
.level-config {
  background-color: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  border-left: 4px solid #6c757d;
}
.level-config.level-low { border-left-color: #28a745; }
.level-config.level-medium { border-left-color: #ffc107; }
.level-config.level-high { border-left-color: #dc3545; }
</style>
{% endblock %}
