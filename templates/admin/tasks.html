{% extends "admin/base_admin.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏{% endblock %}

{% block admin_content %}
<div class="admin-content">
    <h2>üìö –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏</h2>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–∞–Ω–∏–π -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ tasks|length }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ tasks|selectattr("difficulty_level", "<", 0.3)|list|length }}</div>
            <div class="stat-label">–õ–µ–≥–∫–∏—Ö</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ tasks|selectattr("difficulty_level", ">=", 0.3)|selectattr("difficulty_level", "<", 0.6)|list|length }}</div>
            <div class="stat-label">–°—Ä–µ–¥–Ω–∏—Ö</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ tasks|selectattr("difficulty_level", ">=", 0.6)|selectattr("difficulty_level", "<", 0.8)|list|length }}</div>
            <div class="stat-label">–°–ª–æ–∂–Ω—ã—Ö</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ tasks|selectattr("difficulty_level", ">=", 0.8)|list|length }}</div>
            <div class="stat-label">–û—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã—Ö</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ tasks|selectattr("answer_type", "equalto", "system")|list|length }}</div>
            <div class="stat-label">–û–ª–∏–º–ø–∏–∞–¥–Ω—ã—Ö</div>
        </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è —Å –∑–∞–¥–∞–Ω–∏—è–º–∏ -->
    <div class="action-buttons">
        <a href="{{ url_for('tasks.create_task') }}" class="btn btn-primary">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</a>
        <button class="btn btn-secondary" onclick="exportTasks()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–¥–∞–Ω–∏–π</button>
        <button class="btn btn-secondary" onclick="importTasks()">üì• –ò–º–ø–æ—Ä—Ç –∑–∞–¥–∞–Ω–∏–π</button>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filters-section">
        <h3>üîç –§–∏–ª—å—Ç—Ä—ã</h3>
        <div class="filters-grid">
            <div class="filter-item">
                <label for="difficulty-filter">–°–ª–æ–∂–Ω–æ—Å—Ç—å:</label>
                <select id="difficulty-filter" onchange="filterTasks()">
                    <option value="">–í—Å–µ</option>
                    <option value="1">1 - –õ–µ–≥–∫–∏–µ</option>
                    <option value="2">2 - –°—Ä–µ–¥–Ω–∏–µ</option>
                    <option value="3">3 - –°–ª–æ–∂–Ω—ã–µ</option>
                    <option value="4">4 - –û—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–µ</option>
                    <option value="5">5 - –û–ª–∏–º–ø–∏–∞–¥–Ω—ã–µ</option>
                </select>
            </div>
            <div class="filter-item">
                <label for="category-filter">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                <select id="category-filter" onchange="filterTasks()">
                    <option value="">–í—Å–µ</option>
                    <option value="algebra">–ê–ª–≥–µ–±—Ä–∞</option>
                    <option value="geometry">–ì–µ–æ–º–µ—Ç—Ä–∏—è</option>
                    <option value="combinatorics">–ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞</option>
                    <option value="number_theory">–¢–µ–æ—Ä–∏—è —á–∏—Å–µ–ª</option>
                    <option value="logic">–õ–æ–≥–∏–∫–∞</option>
                </select>
            </div>
            <div class="filter-item">
                <label for="search-filter">–ü–æ–∏—Å–∫:</label>
                <input type="text" id="search-filter" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –∑–∞–¥–∞–Ω–∏—è..." onkeyup="filterTasks()">
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–º–ø–æ—Ä—Ç–∞ -->
<div id="importModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>üì• –ò–º–ø–æ—Ä—Ç –∑–∞–¥–∞–Ω–∏–π</h3>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ JSON-—Ñ–∞–π–ª —Å –∑–∞–¥–∞–Ω–∏—è–º–∏ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞. –§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç—É:</p>
        <pre>{
  "tasks": [
    {
      "title": "–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è",
      "description": "–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è",
      "answer_type": "text|number",
      "correct_answer": {"value": "–æ—Ç–≤–µ—Ç", "type": "text|number"},
      "difficulty_level": 2.5,
      "topic": "–¢–µ–º–∞",
      "max_score": 1.0,
      "explanation": "–ü–æ—è—Å–Ω–µ–Ω–∏–µ –∫ —Ä–µ—à–µ–Ω–∏—é"
    }
  ]
}</pre>
        <form id="importForm" action="{{ url_for('admin.import_tasks') }}" method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <input type="file" name="import_file" id="importFile" accept=".json" required>
                <small class="form-text text-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON</small>
            </div>
            <div id="importStatus" class="alert" style="display: none;"></div>
            <div class="form-group text-center">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('importModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞–Ω–∏–π -->
    {% if tasks %}
    <div class="table-container">
        <table class="data-table" id="tasks-table">
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                    </th>
                    <th>ID</th>
                    <th>–ó–∞–¥–∞–Ω–∏–µ</th>
                    <th>–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–ê–≤—Ç–æ—Ä</th>
                    <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                    <th>–ü–æ–ø—ã—Ç–∫–∏</th>
                    <th>–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                <tr class="task-row" data-difficulty="{{ (task.difficulty_level * 5)|round|int }}" data-topic="{{ task.topic or 'other' }}">
                    <td>
                        <input type="checkbox" class="task-select" value="{{ task.id }}">
                    </td>
                    <td>{{ task.id }}</td>
                    <td class="task-info">
                        <strong>{{ task.title or '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' }}</strong>
                        <div class="task-preview">
                            {{ task.description[:100] }}{% if task.description|length > 100 %}...{% endif %}
                        </div>
                        {% if task.answer_type == 'json' %}
                            <small class="task-type">üèÜ –û–ª–∏–º–ø–∏–∞–¥–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ</small>
                        {% else %}
                            <small class="task-type">üìù –û–±—ã—á–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ</small>
                        {% endif %}
                    </td>
                    <td>
                        {% set difficulty_int = (task.difficulty_level * 5)|round|int %}
                        <div class="difficulty-badge difficulty-{{ difficulty_int }}">
                            {{ '%.1f'|format(task.difficulty_level) }}
                        </div>
                    </td>
                    <td>
                        {% if task.topic %}
                            <span class="category-badge">{{ task.topic }}</span>
                        {% else %}
                            <span class="category-badge category-other">–ë–µ–∑ —Ç–µ–º—ã</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if task.created_by %}
                            {{ task.created_by.username }}
                        {% else %}
                            <em>–°–∏—Å—Ç–µ–º–∞</em>
                        {% endif %}
                    </td>
                    <td>
                        {% if task.created_at %}
                            {{ task.created_at.strftime('%d.%m.%Y') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <span class="attempts-count">
                            {{ task.attempts|list|length if task.attempts else 0 }}
                        </span>
                    </td>
                    <td>
                        {% set attempts_list = task.attempts|list %}
                        {% set success_count = attempts_list|selectattr("is_correct", "equalto", true)|list|length %}
                        {% set total_attempts = attempts_list|length %}
                        {% if total_attempts > 0 %}
                            {% set success_rate = (success_count / total_attempts * 100)|round(1) %}
                            <span class="success-rate {% if success_rate >= 70 %}high{% elif success_rate >= 40 %}medium{% else %}low{% endif %}">
                                {{ success_rate }}%
                            </span>
                        {% else %}
                            <span class="success-rate">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="{{ url_for('tasks.view_task', task_id=task.id) }}" class="btn-small btn-view" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">üëÅÔ∏è</a>
                            <a href="{{ url_for('admin.edit_task', task_id=task.id) }}" class="btn-small btn-edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>
                            <form action="{{ url_for('admin.delete_task', task_id=task.id) }}" method="POST" class="delete-form" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.');">
                                <button type="submit" class="btn-small btn-delete" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                            </form>
                            <a href="#" class="btn-small btn-duplicate" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)" onclick="alert('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">üìã</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">üìù</div>
        <h3>–ó–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</h3>
        <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è.</p>
        <a href="{{ url_for('tasks.create_task') }}" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</a>
    </div>
    {% endif %}

    <!-- –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="bulk-actions" id="bulk-actions" style="display: none;">
        <div class="bulk-actions-content">
            <span class="selected-count">–í—ã–±—Ä–∞–Ω–æ: <span id="selected-count">0</span> –∑–∞–¥–∞–Ω–∏–π</span>
            <div class="bulk-buttons">
                <button class="btn btn-warning" onclick="bulkEditSelected()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-danger" onclick="bulkDeleteSelected()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="bulkExportSelected()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
                <button class="btn btn-info" onclick="bulkDuplicateSelected()">üìã –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<style>
/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    overflow: auto;
}

.modal-content {
    background-color: #fff;
    margin: 10% auto;
    padding: 25px;
    border-radius: 8px;
    width: 80%;
    max-width: 700px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    position: relative;
}

.modal .close {
    position: absolute;
    right: 20px;
    top: 10px;
    font-size: 28px;
    font-weight: bold;
    color: #666;
    cursor: pointer;
}

.modal .close:hover {
    color: #000;
}

.modal h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.modal pre {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 5px;
    overflow-x: auto;
    font-size: 14px;
    margin: 15px 0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –∏–º–ø–æ—Ä—Ç–∞ */
#importForm {
    margin-top: 20px;
}

#importForm .form-group {
    margin-bottom: 15px;
}

#importForm input[type="file"] {
    display: block;
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-top: 5px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
.action-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: nowrap;
}

.action-buttons .btn-small {
    padding: 5px 8px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: all 0.2s;
}

.action-buttons .btn-view {
    background-color: #4a90e2;
    color: white;
}

.action-buttons .btn-edit {
    background-color: #f39c12;
    color: white;
}

.action-buttons .btn-delete {
    background-color: #e74c3c;
    color: white;
}

.action-buttons .btn-duplicate {
    background-color: #2ecc71;
    color: white;
}

.action-buttons .btn-small:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã —É–¥–∞–ª–µ–Ω–∏—è */
.delete-form {
    display: inline;
    margin: 0;
    padding: 0;
}

.delete-form button {
    margin: 0;
    padding: 0;
    background: none;
    border: none;
    cursor: pointer;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
    border-left: 4px solid #007bff;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 5px;
}

.stat-label {
    color: #666;
    font-size: 0.9em;
}

.action-buttons {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.filters-section {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.filter-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.filter-item label {
    font-weight: 600;
    color: #333;
    font-size: 0.9em;
}

.filter-item select,
.filter-item input {
    padding: 8px 12px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 0.9em;
}

.table-container {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #333;
    position: sticky;
    top: 0;
}

.task-info strong {
    display: block;
    color: #333;
    margin-bottom: 5px;
}

.task-preview {
    color: #666;
    font-size: 0.8em;
    line-height: 1.4;
    margin-bottom: 5px;
}

.task-type {
    color: #007bff;
    font-weight: 500;
}

.difficulty-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
    text-align: center;
    min-width: 20px;
}

.difficulty-1 { background: #d4edda; color: #155724; }
.difficulty-2 { background: #d1ecf1; color: #0c5460; }
.difficulty-3 { background: #fff3cd; color: #856404; }
.difficulty-4 { background: #f8d7da; color: #721c24; }
.difficulty-5 { background: #d6d8db; color: #383d41; }

.category-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 0.7em;
    font-weight: 500;
    background: #e9ecef;
    color: #495057;
    text-transform: capitalize;
}

.category-other {
    background: #f8f9fa;
    color: #6c757d;
    font-style: italic;
}

.attempts-count {
    font-weight: bold;
    color: #007bff;
}

.success-rate {
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 0.8em;
    font-weight: 500;
}

.success-rate.high {
    background: #d4edda;
    color: #155724;
}

.success-rate.medium {
    background: #fff3cd;
    color: #856404;
}

.success-rate.low {
    background: #f8d7da;
    color: #721c24;
}

.btn-small {
    padding: 4px 8px;
    font-size: 0.8em;
    text-decoration: none;
    border-radius: 4px;
    display: inline-block;
    margin: 1px;
}

.btn-view {
    background: #17a2b8;
    color: white;
}

.btn-edit {
    background: #ffc107;
    color: #333;
}

.btn-delete {
    background: #dc3545;
    color: white;
}

.btn-duplicate {
    background: #6c757d;
    color: white;
}

.btn-view:hover { background: #138496; }
.btn-edit:hover { background: #e0a800; }
.btn-delete:hover { background: #c82333; }
.btn-duplicate:hover { background: #545b62; }

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.empty-icon {
    font-size: 4em;
    margin-bottom: 20px;
}

.bulk-actions {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border: 1px solid #dee2e6;
    z-index: 1000;
}

.bulk-actions-content {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 15px 25px;
}

.selected-count {
    font-weight: 600;
    color: #333;
}

.bulk-buttons {
    display: flex;
    gap: 10px;
}

.bulk-buttons .btn {
    padding: 8px 15px;
    font-size: 0.9em;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .filters-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .data-table {
        font-size: 0.8em;
    }
    
    .bulk-actions-content {
        flex-direction: column;
        gap: 10px;
    }
}
</style>

<script>
let selectedTasks = new Set();

function filterTasks() {
    const difficultyFilter = document.getElementById('difficulty-filter').value;
    const categoryFilter = document.getElementById('category-filter').value;
    const searchFilter = document.getElementById('search-filter').value.toLowerCase();
    
    const rows = document.querySelectorAll('.task-row');
    
    rows.forEach(row => {
        const difficulty = row.getAttribute('data-difficulty');
        const category = row.getAttribute('data-category');
        const text = row.textContent.toLowerCase();
        
        const matchesDifficulty = !difficultyFilter || difficulty === difficultyFilter;
        const matchesCategory = !categoryFilter || category === categoryFilter;
        const matchesSearch = !searchFilter || text.includes(searchFilter);
        
        if (matchesDifficulty && matchesCategory && matchesSearch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.task-select');
    
    checkboxes.forEach(checkbox => {
        if (checkbox.closest('.task-row').style.display !== 'none') {
            checkbox.checked = selectAll.checked;
            if (selectAll.checked) {
                selectedTasks.add(checkbox.value);
            } else {
                selectedTasks.delete(checkbox.value);
            }
        }
    });
    
    updateBulkActions();
}

function updateBulkActions() {
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');
    
    selectedCount.textContent = selectedTasks.size;
    
    if (selectedTasks.size > 0) {
        bulkActions.style.display = 'block';
    } else {
        bulkActions.style.display = 'none';
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('task-select')) {
        if (e.target.checked) {
            selectedTasks.add(e.target.value);
        } else {
            selectedTasks.delete(e.target.value);
        }
        updateBulkActions();
    }
});

// –§—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞/–∏–º–ø–æ—Ä—Ç–∞ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–±—â—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É task-management.js
// –§—É–Ω–∫—Ü–∏–∏ openImportModal(), exportTasks(), closeImportModal() –¥–æ—Å—Ç—É–ø–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω–æ

// –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
function bulkEdit() {
    alert('–ú–∞—Å—Å–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π\n(–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
}

function bulkEditSelected() {
    if (selectedTasks.size === 0) return;
    alert(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${selectedTasks.size} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π\n(–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)`);
}

function bulkDeleteSelected() {
    if (selectedTasks.size === 0) return;
    if (confirm(`–£–¥–∞–ª–∏—Ç—å ${selectedTasks.size} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π?`)) {
        alert('–£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π\n(–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
    }
}

function bulkExportSelected() {
    if (selectedTasks.size === 0) {
        alert('–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏–∑ –æ–±—â–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    const taskIds = Array.from(selectedTasks);
    if (window.taskManager) {
        window.taskManager.exportSelectedTasks(taskIds);
    } else {
        console.error('TaskManager not initialized');
        alert('–û—à–∏–±–∫–∞: –ú–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–¥–∞–Ω–∏–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    }
}

function bulkDuplicateSelected() {
    if (selectedTasks.size === 0) return;
    alert(`–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ${selectedTasks.size} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π\n(–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)`);
}
</script>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/task-management.js') }}"></script>
{% endblock %}
