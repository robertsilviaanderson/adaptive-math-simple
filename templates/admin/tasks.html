{% from "shared/modals.html" import upload_modal %}
{% extends "shared/base.html" %}

{% block title %}–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è ‚Äî Adaptive Math{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h1 class="h4 fw-bold my-2">üìö –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è</h1>

    <div class="d-flex flex-wrap gap-2 my-2">
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">‚Üê –ü–∞–Ω–µ–ª—å</a>
      {% if current_user.role == 'teacher' %}
        <a href="{{ url_for('tasks.create_task') }}" class="btn btn-primary">‚ûï –°–æ–∑–¥–∞—Ç—å</a>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importTasksModal">‚§¥Ô∏è –ò–º–ø–æ—Ä—Ç</button>
        <a href="{{ url_for('tasks.export_tasks') }}" class="btn btn-info">‚§µÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö</a>
        <button id="exportSelectedBtn" class="btn btn-outline-info" disabled>‚§µÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
      {% endif %}
    </div>
  </div>

  {# –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–º–µ #}
  <form class="row g-2 align-items-end mb-3" method="get" action="{{ url_for('tasks.list_tasks') }}">
    <div class="col-sm-8 col-md-6 col-lg-4">
      <label for="topic_id" class="form-label mb-1">–§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–º–µ</label>
      <select id="topic_id" name="topic_id" class="form-select">
        <option value="">–í—Å–µ —Ç–µ–º—ã</option>
        {% for t in (topics or []) %}
          <option value="{{ t.id }}" {% if request.args.get('topic_id', type=int) == t.id %}selected{% endif %}>
            {{ t.name }}{% if t.code %} ({{ t.code }}){% endif %}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-primary">–ü–æ–∫–∞–∑–∞—Ç—å</button>
    </div>
    {% if request.args.get('topic_id') %}
    <div class="col-auto">
      <a class="btn btn-outline-secondary" href="{{ url_for('tasks.list_tasks') }}">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </div>
    {% endif %}
  </form>

  {% if tasks and tasks|length > 0 %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            {% if current_user.role == 'teacher' %}
              <th style="width:36px;"><input type="checkbox" id="selectAll"></th>
            {% endif %}
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–¢–µ–º–∞</th>
            <th>–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
            <th>–ú–∞–∫—Å. –±–∞–ª–ª</th>
            <th>–ê–∫—Ç–∏–≤–Ω–∞</th>
            <th>–°–æ–∑–¥–∞–Ω–æ</th>
            <th style="width:1%;"></th>
          </tr>
        </thead>
        <tbody>
          {% for task in tasks %}
          <tr>
            {% if current_user.role == 'teacher' %}
              <td><input type="checkbox" class="task-checkbox" value="{{ task.id }}"></td>
            {% endif %}

            <td class="fw-semibold">{{ task.title or '‚Äî' }}</td>

            <td>
              {{ (task.topic_ref.name if task.topic_ref else '‚Äî') }}
              {% if task.topic_ref and task.topic_ref.code %}
                <div class="small text-muted"><code>{{ task.topic_ref.code }}</code></div>
              {% endif %}
            </td>

            <td>
              <span class="badge
                {% if task.level == 'low' %} bg-success
                {% elif task.level == 'medium' %} bg-warning text-dark
                {% elif task.level == 'high' %} bg-danger
                {% else %} bg-secondary{% endif %}">
                {% if task.level == 'low' %}üü¢ –ù–∏–∑–∫–∏–π
                {% elif task.level == 'medium' %}üü° –°—Ä–µ–¥–Ω–∏–π
                {% elif task.level == 'high' %}üî¥ –í—ã—Å–æ–∫–∏–π
                {% else %}{{ task.level|default('‚Äî') }}{% endif %}
              </span>
            </td>

            <td>{{ (task.max_score if task.max_score is not none else 0) }}</td>

            <td>
              {% if task.is_active %}<span class="badge bg-primary">–¥–∞</span>
              {% else %}<span class="badge bg-secondary">–Ω–µ—Ç</span>{% endif %}
            </td>

            <td>{{ task.created_at.strftime('%d.%m.%Y') if task.created_at else '‚Äî' }}</td>

            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <a href="{{ url_for('tasks.view_task', task_id=task.id) }}" class="btn btn-outline-primary">
                  {% if current_user.role == 'student' %}üìù –†–µ—à–∞—Ç—å{% else %}üëÅÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å{% endif %}
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info">
      <div class="fw-semibold">–ó–∞–¥–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
      <div class="small">–°–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞—á—É –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∏–∑ —Ñ–∞–π–ª–∞.</div>
    </div>
  {% endif %}

</div>

{# –ú–æ–¥–∞–ª–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –¢–í–û–ô upload_modal #}
{{ upload_modal(
  id='importTasksModal',
  title='–ò–º–ø–æ—Ä—Ç –∑–∞–¥–∞—á',
  action=url_for('tasks.import_tasks'),
  input_name='file',
  accept='.json',
  submit_text='–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å',
  method='post',
  csrf_html='<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">' | safe,
  header_note='''
    <div class="alert alert-info small mb-0"><strong>–§–æ—Ä–º–∞—Ç:</strong>
<pre class="mb-0">[
  {
    "title": "–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è. –ë–∞–∑–æ–≤–∞—è",
    "description": "–†–µ—à–∏—Ç–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ ...",
    "answer_type": "number|variables|interval|sequence",
    "correct_answer": {...},       // —Å–º. docs/answer_json_format.md
    "answer_schema": {...},
    "explanation": "–ü–æ–¥—Å–∫–∞–∑–∫–∞...",
    "topic_code": "quadratic_equations",    // –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ
    "level": "low|medium|high",
    "max_score": 1.0,
    "is_active": true
  }
]</pre></div>
  ''' | safe
) }}
{% endblock %}

{% block scripts %}
<script>
(function() {
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const selectAll = $('#selectAll');
  const boxes = $$('.task-checkbox');
  const exportBtn = $('#exportSelectedBtn');

  if (selectAll) {
    selectAll.addEventListener('change', () => {
      boxes.forEach(cb => cb.checked = selectAll.checked);
      updateExportButton();
    });
    boxes.forEach(cb => cb.addEventListener('change', updateExportButton));
  }

  function updateExportButton() {
    if (!exportBtn) return;
    const count = $$('.task-checkbox:checked').length;
    exportBtn.disabled = count === 0;
    exportBtn.textContent = count ? `‚§µÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö (${count})` : '‚§µÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö';
  }

  if (exportBtn) {
    exportBtn.addEventListener('click', async () => {
      const ids = $$('.task-checkbox:checked').map(cb => parseInt(cb.value));
      if (!ids.length) return;

      try {
        const resp = await fetch('{{ url_for("tasks.export_tasks") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
          },
          body: JSON.stringify({ task_ids: ids })
        });
        if (!resp.ok) {
          const j = await resp.json().catch(()=>({message:'Server error'}));
          throw new Error(j.message || '–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
        }
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tasks_export_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      } catch(e) { alert(e.message || e); }
    });
  }
})();
</script>
{% endblock %}
