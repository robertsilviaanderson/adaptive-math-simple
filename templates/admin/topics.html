{% from "shared/modals.html" import confirm_modal, upload_modal %}
{% extends "admin/base_admin.html" %}

{% block title %}Управление темами{% endblock %}

{% block admin_content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="text-info-emphasis"><i class="fa fa-book"></i> Управление темами</h2>
        <div class="btn-group" role="group">
            <a href="{{ url_for('admin.create_topic') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Создать тему
            </a>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importTopicsModal">
                <i class="fas fa-upload"></i> Импорт
            </button>
            <a href="{{ url_for('admin.export_topics') }}" class="btn btn-info">
                <i class="fas fa-download"></i> Экспорт всех
            </a>
        </div>
    </div>

    {% if topics %}
    <div class="table-container">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>Код</th>
                    <th>Название</th>
                    <th>Описание</th>
                    <th>Заданий</th>
                    <th>Создано</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for topic in topics %}
                <tr>
                    <td><input type="checkbox" class="topic-checkbox" value="{{ topic.id }}"></td>
                    <td><code>{{ topic.code }}</code></td>
                    <td><strong>{{ topic.name }}</strong></td>
                    <td>{{ topic.description[:100] }}{% if topic.description|length > 100 %}...{% endif %}</td>
                    <td>
                        <span class="badge rounded-pill {% if topic.tasks.count() > 0 %} bg-info {% else %} bg-secondary {% endif %}">{{ topic.tasks.count() }}</span>
                    </td>
                    <td>{{ topic.created_at.strftime('%d.%m.%Y') if topic.created_at else '-' }}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('admin.edit_topic', topic_id=topic.id) }}" 
                               class="btn btn-outline-primary" title="Редактировать">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% if topic.tasks.count() == 0 %}
                            <a href="#" 
                                    class="btn btn-outline-danger" 
                                    title="Удалить"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteTopicModal"
                                    data-topic-id="{{ topic.id }}"
                                    data-topic-name="{{ topic.name }}">
                                    <i class="fas fa-trash"></i>
                                </a>
                            {% else %}
                            <button type="button" class="btn btn-outline-secondary" disabled 
                                    title="Нельзя удалить: есть связанные задания">
                                <i class="fas fa-lock"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="mt-3">
        <button type="button" class="btn btn-info" onclick="exportSelected()" id="exportSelectedBtn" disabled>
            <i class="fas fa-download"></i> Экспорт выбранных
        </button>
        <span class="text-muted ms-2">Всего: <span id="selectedCount">0</span></span>
    </div>
    {% else %}
    <div class="alert alert-info">
        <h4>Темы не найдены</h4>
        <p>Создайте первую тему или импортируйте темы из файла.</p>
        <a href="{{ url_for('admin.create_topic') }}" class="btn btn-primary">Создать тему</a>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importTopicsModal">Импорт тем</button>
    </div>
    {% endif %}

<!-- Форма для удаления темы -->
<form id="deleteForm" method="POST" style="display: none;">
    {{ csrf_field() }}
</form>


{# URL-шаблон с нулём для JS-подстановки #}
{% set delete_topic_url_template = "__URL__" %}
{% set topics_format_note %}
    <div class="alert alert-info small mb-3">
    <strong>Формат:</strong>
    <pre class="mb-0">[
        {
            "code": "algebra_basics",
            "name": "Основы алгебры",
            "description": "Базовые понятия",
            "level_configs": {
              "low":    {"task_count_threshold": 10, "reference_time": 900, "penalty_weights": [0.7, 0.4]},
              "medium": {"task_count_threshold": 10, "reference_time": 900, "penalty_weights": [0.7, 0.4]},
              "high":   {"task_count_threshold": 10, "reference_time": 900, "penalty_weights": [0.7, 0.4]}
            }
          }
    ]</pre>
    </div>
{% endset %}

{% call confirm_modal(
    id='deleteTopicModal',
    title='Удаление темы',
    body='Вы действительно хотите удалить тему <strong id="deleteTopicName"></strong>?',
    action=delete_topic_url_template,
    confirm_text='Удалить навсегда',
    confirm_class='btn-danger',
    alert_note='Это действие нельзя отменить.'
) %}
{{ csrf_field() }}
{% endcall %}

{{ upload_modal(
    id='importTopicsModal',
    title='Импорт тем',
    action=url_for('admin.import_topics'),
    input_name='file',
    accept='.json',
    submit_text='Импортировать',
    method='post',
    csrf_html=csrf_field(),
    header_note=topics_format_note   
) }}

<script>
// Управление чекбоксами
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.topic-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateExportButton();
});

document.querySelectorAll('.topic-checkbox').forEach(cb => {
    cb.addEventListener('change', updateExportButton);
});

function updateExportButton() {
    const selected = document.querySelectorAll('.topic-checkbox:checked');
    const exportBtn = document.getElementById('exportSelectedBtn');
    exportBtn.disabled = selected.length === 0;
    document.getElementById('selectedCount').textContent = selected.length;
}

<!-- Управление модальным окном удаления -->
document.addEventListener('DOMContentLoaded', () => {
    const modalEl = document.getElementById('deleteTopicModal');
    if (!modalEl) return;
    const form = modalEl.querySelector('form');
    const nameSpan = document.getElementById('deleteTopicName');

    modalEl.addEventListener('show.bs.modal', (event) => {
        const btn = event.relatedTarget;
        const topicId = btn.getAttribute('data-topic-id');
        const topicName = btn.getAttribute('data-topic-name');
        const body = modalEl.querySelector('.modal-body');
        body.innerHTML = `<p class="mb-0">Удалить тему <strong>${topicName}</strong>?</p>     
        <p class="text-danger small mt-2 mb-0">
            Это действие нельзя отменить.
        </p>`;
        nameSpan.textContent = topicName;
        form.action = `/admin/topics/${topicId}/delete`;
    });
});

// Импорт тем
    function importTopics() {
        const form = document.getElementById('importForm');
        const formData = new FormData(form);

        // отладка: что реально уходит
        for (const [k, v] of formData.entries()) {
            console.log('FD:', k, v, v && v.name);
        }
        console.log('direct file:', document.getElementById('importFile').files[0]);

        fetch('{{ url_for("admin.import_topics") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('importModal'))?.hide();
                alert('Успешно!\n' + data.message);
                location.reload();
            } else {
                alert('Ошибка!\n' + data.message);
            }
        })
        .catch(error => {
            alert('Ошибка при импорте: ' + error);
        });
            
    }

// Экспорт выбранных тем
function exportSelected() {
    const selected = Array.from(document.querySelectorAll('.topic-checkbox:checked'))
                          .map(cb => parseInt(cb.value));
    
    if (selected.length === 0) {
        alert('Выберите темы для экспорта');
        return;
    }
    
    fetch('{{ url_for("admin.export_topics") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        },
        body: JSON.stringify({topic_ids: selected})
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            return response.json().then(data => {
                throw new Error(data.message || 'Ошибка при экспорте');
            });
        }
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `selected_topics_export_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    })
    .catch(error => {
        alert('Ошибка при экспорте: ' + error.message);
    });
}
</script>

{% endblock %}
