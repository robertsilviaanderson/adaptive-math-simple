{# Макросы для форм с автоматическим включением CSRF #}

{# Макрос для начала формы с автоматическим CSRF токеном #}
{% macro form_start(action='', method='POST', class='', id='', enctype='') %}
<form 
    {% if action %}action="{{ action }}"{% endif %}
    method="{{ method }}"
    {% if class %}class="{{ class }}"{% endif %}
    {% if id %}id="{{ id }}"{% endif %}
    {% if enctype %}enctype="{{ enctype }}"{% endif %}
>
    {# Автоматически добавляем CSRF токен для всех POST форм #}
    {% if method.upper() == 'POST' %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    {% endif %}
{% endmacro %}

{# Макрос для скрытого CSRF поля (для ручного добавления) #}
{% macro csrf_field() %}
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
{% endmacro %}

{# Макрос для получения CSRF токена в JavaScript #}
{% macro csrf_js() %}
<script>
    // Глобальная функция для получения CSRF токена
    window.getCSRFToken = function() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? meta.getAttribute('content') : '';
    };
    
    // Автоматически добавляем CSRF токен во все AJAX запросы
    if (typeof $ !== 'undefined') {
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", getCSRFToken());
                }
            }
        });
    }
    
    // Для fetch API
    const originalFetch = window.fetch;
    window.fetch = function(url, options = {}) {
        if (options.method && !/^(GET|HEAD|OPTIONS|TRACE)$/i.test(options.method)) {
            options.headers = options.headers || {};
            options.headers['X-CSRFToken'] = getCSRFToken();
        }
        return originalFetch(url, options);
    };
</script>
{% endmacro %}
